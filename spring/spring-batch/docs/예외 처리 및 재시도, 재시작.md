#### 인덱스
- [Job 실행 중 발생한 예외 처리](#job-실행-중-발생한-예외-처리)
- [재시도: Retry, Skip](#재시도-retry-skip)
- [재시작](#재시작)

## Job 실행 중 발생한 예외 처리

`JobExecutionListener`를 구현하여 특정 JobExecution의 실행이 끝난 후 실패했는지 확인할 수 있다

아래의 리스너를 Job에 등록하면 매번 JobExecution의 실행 이후 실패한 Job에 대한 정보를 출력한다

```java
@Component
public class FailureJobExecutionListener implements JobExecutionListener {

    @Override
    public void afterJob(JobExecution jobExecution) {
        if (jobExecution.getStatus().isUnsuccessful()) {
            // logging, sending alert ...
            var jobName = jobExecution.getJobInstance().getJobName();
            var jobId = jobExecution.getJobId();
            var parameters = jobExecution.getJobParameters().getParameters();
            var exceptions = jobExecution.getAllFailureExceptions();

            System.out.println(
                """
                Job failed with the following states
                - name: %s
                - id: %s
                - parameters: %s
                - exceptions %s 
                """.formatted(jobName, jobId, parameters, exceptions)
            );
        }
    }
    
}
```

```java
// 실패가 발생하는 Job
// 리스너를 통해 실패 정보를 로깅한다
@Bean
Job failureLoggingJob(
    JobRepository jobRepository,
    @Qualifier("failureJobExecutionListener") JobExecutionListener listener,
    @Qualifier("failureStep") Step step) {

    return new JobBuilder("failureJob", jobRepository)
            .start(step)
            .listener(listener)
            .build();
}
```


## 재시도: Retry, Skip

Step 처리 중 예외가 발생한 경우 해당 실행을 재시도하거나 스킵(무시)할 수 있다

```java
@Bean
Step retryStep(
    JobRepository jobRepository, 
    PlatformTransactionManager txManager,
    @Qualifier("failureJobRetryListener") RetryListener listener) {

    return new StepBuilder("retryStep", jobRepository)
        .<Object, Object>chunk(10, txManager)
        .reader(() -> {throw new RuntimeException();})
        .processor(i -> new Object())
        .writer(writerStub())
        .faultTolerant() 
        .retry(RuntimeException.class) // RuntimeException에 대해 retry 시도
        .retryLimit(3) // 최대 3번 retry 시도
        .skip(SkipException.class) // 스킵할 특정 예외 지정
        .skipLimit(5) // 스킵할 예외에 대한 최대 누적 횟수 (설정한 수 이상으로 스킵 예외 발생 시 Step FAILED 처리)
        .listener(listener) // retry 리스너 등록
        .build();
}
```


## 재시작

재시작은 이전 실행(JobExecution)이 실패 또는 중단된 경우 동일한 Job을 **같은 JobParameters**로 다시 실행했을 때, **실패한 Step부터 이어서 실행**하는 기능이다

**이미 성공한 Step은 건너뛰고 실패했던 Step만 다시 실행한다**

스프링 배치는 내부적으로 JobRepository(일반적으로 DB 기반)에 아래의 정보를 저장한다
- Job 실행 이력(JobExecution)
- 각 Step 실행 상태(StepExecution)
- Step별 중간 상태(ExecutionContext)

재시작 시 저장된 ExecutionContext를 기반으로 Step의 Reader/Writer가 이전 처리 위치를 복원할 수 있다

재시작이 동작하려면 아래와 같은 전제 조건이 만족되어야 한다
- JobRepository가 DB 기반이어야 한다
- Job 이름이 동일해야 한다 (다르면 새 Job으로 간주)
- JobParameters가 동일해야 한다 (다르면 새 JobExecution으로 간주)
- Reader/Writer가 stateful해야 한다 (@StepScope + ExecutionContext)
- 실패한 Step이 FAILED 상태여야 한다

위의 전제 조건을 모두 만족한 상태에서 다시 Job을 실행하면 스프링 배치는 자동으로 실패한 지점부터 재시작한다

참고로 아래와 같이 설정하면 재시작을 방지할 수 있다 (같은 조건이라도 매번 전체를 새롭게 시작함)

```java
@Bean
Job stableJob(Step step) {
    return new JobBuilder("stableJob", jobRepository)
            .preventRestart() // 재시작 방지
            .start(step)
            .build();
}
```